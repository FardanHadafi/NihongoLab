openapi: 3.1.0
info:
  title: NihongoLab API
  description: |
    Complete API reference for NihongoLab - A Japanese language learning platform with spaced repetition system (SRS),
    JLPT-aligned content, and gamified progress tracking.
    
    **Features:**
    - Email/password authentication with Better Auth
    - Spaced repetition learning algorithm
    - Hiragana, Katakana, and Kanji practice
    - JLPT N5-N1 vocabulary and questions
    - User progress tracking with XP and levels
    - Dashboard with learning analytics

  version: 1.0.0
  contact:
    name: NihongoLab Support

servers:
  - url: http://localhost:3000/api
    description: Local development server
  - url: http://localhost:5173
    description: Frontend development server (SvelteKit)

components:
  securitySchemes:
    cookieAuth:
      type: apiKey
      in: cookie
      name: better-auth.session_token
      description: Session token cookie set by Better Auth
    bearerAuth:
      type: http
      scheme: bearer
      description: Bearer token for API authentication

  schemas:
    User:
      type: object
      properties:
        id:
          type: string
          description: Unique user identifier
        name:
          type: string
          description: User's display name
        email:
          type: string
          format: email
        emailVerified:
          type: boolean
          description: Whether the user's email has been verified
        image:
          type: string
          nullable: true
          description: Profile image URL (Cloudinary)
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
      required:
        - id
        - name
        - email
        - emailVerified
        - createdAt
        - updatedAt

    UserProfile:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        image:
          type: string
          nullable: true
        currentExp:
          type: integer
          description: Current experience points
        levelName:
          type: string
          description: Current JLPT level (N5, N4, N3, N2, N1)
          nullable: true
        requiredExp:
          type: integer
          description: XP required to reach next level
          nullable: true

    Question:
      type: object
      properties:
        id:
          type: integer
        character:
          type: string
          description: The question text (hiragana/katakana/kanji character)
        options:
          type: array
          items:
            type: string
          description: Multiple choice options
      required:
        - id
        - character
        - options

    ReviewQuestion:
      type: object
      properties:
        progressId:
          type: integer
        questionId:
          type: integer
        levelId:
          type: integer
        scriptType:
          type: string
          enum: [hiragana, katakana, kanji]
        questionType:
          type: string
          enum: [reading, meaning, kanji-to-reading, kanji-to-meaning, meaning-to-kanji]
        questionText:
          type: string
        options:
          type: array
          items:
            type: string
        attempts:
          type: integer
        isCorrect:
          type: boolean
        answeredAt:
          type: string
          format: date-time
        lastAttemptedAt:
          type: string
          format: date-time
          nullable: true
        nextReviewAt:
          type: string
          format: date-time
          nullable: true
        easeFactor:
          type: integer
          description: SRS ease factor (130-300)
          nullable: true

    SubmitAnswerResponse:
      type: object
      properties:
        isCorrect:
          type: boolean
        correctAnswer:
          type: string
        expEarned:
          type: integer
          description: XP earned (only on first correct answer)
        leveledUp:
          type: boolean
          description: Whether user leveled up
        newLevelId:
          type: integer
          nullable: true
        userExp:
          type: integer
          nullable: true
        attempts:
          type: integer
          description: Total attempts for this question
      required:
        - isCorrect
        - correctAnswer
        - expEarned
        - leveledUp

    ReviewAnswerResponse:
      type: object
      properties:
        isCorrect:
          type: boolean
        correctAnswer:
          type: string
        nextReviewAt:
          type: string
          format: date-time
          description: Next scheduled review date (SRS)
        easeFactor:
          type: integer
          description: Updated ease factor
      required:
        - isCorrect
        - correctAnswer
        - nextReviewAt
        - easeFactor

    CompleteLessonResponse:
      type: object
      properties:
        total:
          type: integer
        correct:
          type: integer
        accuracy:
          type: number
          format: float
          description: Accuracy percentage (0-1)
        expEarned:
          type: integer
        userExp:
          type: integer
        levelId:
          type: integer
          nullable: true

    DashboardData:
      type: object
      properties:
        user:
          type: object
          properties:
            name:
              type: string
            currentExp:
              type: integer
            currentLevel:
              type: object
              nullable: true
              properties:
                name:
                  type: string
                  example: N5
                requiredExp:
                  type: integer
            nextLevel:
              type: object
              nullable: true
              properties:
                name:
                  type: string
                  example: N4
                requiredExp:
                  type: integer
        stats:
          type: object
          properties:
            totalAnswered:
              type: integer
            correctAnswers:
              type: integer
            accuracyRate:
              type: integer
              description: Percentage accuracy (0-100)
            streak:
              type: integer
              description: Current daily streak
            lastActiveAt:
              type: string
              format: date-time
        levelProgress:
          type: array
          items:
            type: object
            properties:
              levelName:
                type: string
              totalQuestions:
                type: integer
              answeredCorrect:
                type: integer
              percentage:
                type: integer
        recentActivity:
          type: array
          items:
            type: object
            properties:
              date:
                type: string
                format: date
              count:
                type: integer
          description: Last 7 days of activity
        questionsMastered:
          type: integer
          description: Total questions answered correctly at least once
        questionsNeedingReview:
          type: integer
          description: Questions that need review (SRS or incorrect)

    VocabularyWord:
      type: object
      properties:
        id:
          type: integer
        word:
          type: string
          description: Japanese word
        reading:
          type: string
          nullable: true
          description: Hiragana/katakana reading
        meaning:
          type: string
          description: English meaning
        category:
          type: string
          nullable: true
          description: Category (food, time, verb, etc.)
        partOfSpeech:
          type: string
          description: Part of speech

    VocabularyCategory:
      type: object
      properties:
        category:
          type: string
        items:
          type: array
          items:
            $ref: '#/components/schemas/VocabularyWord'

    VocabularyResponse:
      type: object
      properties:
        levelId:
          type: integer
        limit:
          type: integer
        search:
          type: string
          nullable: true
        nextCursor:
          type: integer
          nullable: true
          description: Use this as cursor for next page
        categories:
          type: array
          items:
            $ref: '#/components/schemas/VocabularyCategory'

    Error:
      type: object
      properties:
        error:
          type: string
      required:
        - error

security:
  - cookieAuth: []
  - bearerAuth: []

tags:
  - name: Authentication
    description: Better Auth endpoints for user authentication and session management
  - name: Users
    description: User profile management and Cloudinary image uploads
  - name: Learning
    description: Learning sessions with instant feedback and XP rewards
  - name: Dashboard
    description: User progress, statistics, and spaced repetition reviews
  - name: Vocabulary
    description: JLPT-aligned vocabulary browsing with pagination

paths:
  # ============================================
  # AUTHENTICATION ENDPOINTS (Better Auth)
  # ============================================
  /auth/sign-up/email:
    post:
      tags:
        - Authentication
      summary: Register new user with email/password
      operationId: signUp
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  example: John Doe
                email:
                  type: string
                  format: email
                  example: user@example.com
                password:
                  type: string
                  format: password
                  minLength: 8
                  example: SecurePass123!
                image:
                  type: string
                  nullable: true
              required:
                - name
                - email
                - password
      responses:
        '200':
          description: User created successfully. Verification email sent.
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    $ref: '#/components/schemas/User'
                  token:
                    type: string
                    nullable: true
        '422':
          description: User already exists
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: User already exists

  /auth/sign-in/email:
    post:
      tags:
        - Authentication
      summary: Sign in with email and password
      operationId: signIn
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
                  format: password
                rememberMe:
                  type: boolean
                  default: true
              required:
                - email
                - password
      responses:
        '200':
          description: Signed in successfully
          headers:
            Set-Cookie:
              schema:
                type: string
                example: better-auth.session_token=abc123; HttpOnly; Secure; SameSite=Lax
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    $ref: '#/components/schemas/User'
                  token:
                    type: string
                  redirect:
                    type: boolean
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Email not verified
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/sign-out:
    post:
      tags:
        - Authentication
      summary: Sign out current user
      operationId: signOut
      security:
        - cookieAuth: []
      responses:
        '200':
          description: Signed out successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean

  /auth/get-session:
    get:
      tags:
        - Authentication
      summary: Get current session and user data
      operationId: getSession
      security:
        - cookieAuth: []
      responses:
        '200':
          description: Current session data or null if not authenticated
          content:
            application/json:
              schema:
                type: object
                nullable: true
                properties:
                  session:
                    type: object
                    properties:
                      id:
                        type: string
                      userId:
                        type: string
                      expiresAt:
                        type: string
                        format: date-time
                  user:
                    $ref: '#/components/schemas/User'

  # ============================================
  # USER ENDPOINTS
  # ============================================
  /users/me:
    get:
      tags:
        - Users
      summary: Get current user profile with level info
      operationId: getUserProfile
      security:
        - cookieAuth: []
      responses:
        '200':
          description: User profile with current JLPT level
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfile'
        '401':
          description: Unauthorized - No valid session
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Email not verified
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    patch:
      tags:
        - Users
      summary: Update user profile (name, image)
      operationId: updateUserProfile
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  minLength: 1
                image:
                  type: string
                  nullable: true
                  description: URL to profile image (usually from Cloudinary)
      responses:
        '200':
          description: Profile updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '400':
          description: Update failed or invalid input
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /users/upload-image:
    post:
      tags:
        - Users
      summary: Upload profile image to Cloudinary
      description: |
        Uploads an image file to Cloudinary with automatic transformations:
        - Resized to 400x400 with face detection
        - Optimized quality
        - Auto format conversion (WebP support)
        
        **Constraints:**
        - Max file size: 5MB
        - Allowed formats: JPEG, PNG, WEBP
      operationId: uploadProfileImage
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                image:
                  type: string
                  format: binary
                  description: Image file to upload
              required:
                - image
      responses:
        '200':
          description: Image uploaded successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  imageUrl:
                    type: string
                    format: uri
                    example: https://res.cloudinary.com/nihongolab/image/upload/v1234/nihongolab/avatars/user_abc_1234567890.jpg
        '400':
          description: Invalid file (wrong type, too large, or missing)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                noFile:
                  value:
                    error: No image file provided
                tooLarge:
                  value:
                    error: File size exceeds 5MB limit
                invalidType:
                  value:
                    error: Invalid file type. Only JPEG, PNG, and WEBP are allowed
        '500':
          description: Cloudinary upload failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # ============================================
  # LEARNING ENDPOINTS
  # ============================================
  /learn/{script}:
    get:
      tags:
        - Learning
      summary: Get random questions by script type
      description: |
        Returns random questions for practice sessions.
        
        **Script Types:**
        - `hiragana` - Returns reading-only questions
        - `katakana` - Returns reading-only questions
        - `kanji` - Returns all question types (reading, meaning, kanji-to-reading, etc.)
      operationId: getQuestionsByScript
      security: []
      parameters:
        - name: script
          in: path
          required: true
          schema:
            type: string
            enum: [hiragana, katakana, kanji]
          description: Type of Japanese script
        - name: limit
          in: query
          schema:
            type: integer
            default: 10
            minimum: 1
            maximum: 100
          description: Number of questions to return
      responses:
        '200':
          description: Random questions for the specified script
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Question'
        '400':
          description: Invalid script type
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /learn/submit:
    post:
      tags:
        - Learning
      summary: Submit answer and get instant feedback
      description: |
        Submit an answer for a question. Returns correctness and awards XP on first correct answer.
        
        **XP System:**
        - First correct answer: +1 XP
        - Subsequent correct answers: No XP
        - Leveling up happens automatically when XP threshold is reached
        
        **Progress Tracking:**
        - Creates or updates user_progress record
        - Increments attempt counter
        - Updates user_stats for dashboard
      operationId: submitAnswer
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                questionId:
                  type: integer
                  example: 42
                answer:
                  type: string
                  example: あ
              required:
                - questionId
                - answer
      responses:
        '200':
          description: Answer processed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubmitAnswerResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Question not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /learn/complete:
    post:
      tags:
        - Learning
      summary: Complete a lesson with multiple questions
      description: |
        Completes a lesson and awards XP based on accuracy.
        
        **XP Rewards:**
        - 100% accuracy: 1 XP
        - 70%+ accuracy: 1 XP
        - Below 70%: 0 XP
        
        **Streak Logic:**
        - Continues streak if active today or yesterday
        - Resets to 1 if gap detected
      operationId: completeLesson
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                questionIds:
                  type: array
                  items:
                    type: integer
                  minItems: 5
                  example: [1, 2, 3, 4, 5]
              required:
                - questionIds
      responses:
        '200':
          description: Lesson completed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CompleteLessonResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Failed to complete lesson
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # ============================================
  # DASHBOARD ENDPOINTS
  # ============================================
  /dashboard:
    get:
      tags:
        - Dashboard
      summary: Get comprehensive user dashboard
      description: |
        Returns complete dashboard data including:
        - User profile with current/next level
        - Statistics (total answered, accuracy, streak)
        - Level-wise progress breakdown
        - Recent activity (last 7 days)
        - Mastered questions count
        - Questions needing review count
      operationId: getDashboard
      security:
        - cookieAuth: []
      responses:
        '200':
          description: Dashboard data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DashboardData'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /dashboard/review:
    get:
      tags:
        - Dashboard
      summary: Get count of questions needing review
      description: |
        Returns the number of questions that need review based on:
        - Multiple attempts (attempts > 1)
        - Previously answered incorrectly
        - SRS due date passed (nextReviewAt <= now)
      operationId: getReviewCount
      security:
        - cookieAuth: []
      responses:
        '200':
          description: Review count
          content:
            application/json:
              schema:
                type: object
                properties:
                  reviewCount:
                    type: integer
                    example: 12

  /dashboard/review/start:
    get:
      tags:
        - Dashboard
      summary: Start spaced repetition review session
      description: |
        Returns up to 20 questions that need review, prioritized by:
        1. SRS due date (earliest first)
        2. Last attempted date (oldest first)
        
        **Review Criteria:**
        - Multiple attempts OR incorrect answers
        - SRS-ready questions (nextReviewAt is due or null)
      operationId: startReview
      security:
        - cookieAuth: []
      responses:
        '200':
          description: Review questions with progress data
          content:
            application/json:
              schema:
                type: object
                properties:
                  questions:
                    type: array
                    items:
                      $ref: '#/components/schemas/ReviewQuestion'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /dashboard/review/answer:
    post:
      tags:
        - Dashboard
      summary: Submit answer for review question
      description: |
        Processes review answer with spaced repetition algorithm.
        
        **SRS Algorithm:**
        - **Correct answer:** Ease factor +10 (max 300), next review = ease/100 days
        - **Incorrect answer:** Ease factor -20 (min 130), next review = 1 day
        - Updates attempts counter and lastAttemptedAt
      operationId: answerReview
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                questionId:
                  type: integer
                  example: 42
                userAnswer:
                  type: string
                  minLength: 1
                  example: あ
              required:
                - questionId
                - userAnswer
      responses:
        '200':
          description: Review answer processed with updated SRS data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReviewAnswerResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Progress not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /dashboard/kanji:
    get:
      tags:
        - Dashboard
      summary: Get kanji questions by JLPT level
      description: |
        Returns all kanji questions for the specified JLPT level.
        Currently supports N5 and N4.
      operationId: getKanjiByLevel
      security:
        - cookieAuth: []
      parameters:
        - name: level
          in: query
          required: true
          schema:
            type: string
            enum: [N5, N4]
          description: JLPT level
          example: N5
      responses:
        '200':
          description: Kanji questions for the specified level
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: integer
                    questionText:
                      type: string
                      description: Kanji character
                    options:
                      type: array
                      items:
                        type: string
                    scriptType:
                      type: string
                      example: kanji
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # ============================================
  # VOCABULARY ENDPOINTS
  # ============================================
  /vocabulary:
    get:
      tags:
        - Vocabulary
      summary: Browse vocabulary with pagination and search
      description: |
        Returns paginated vocabulary grouped by categories.
        
        **Pagination:**
        - Uses cursor-based pagination (category ID)
        - Returns `nextCursor` for next page (null if last page)
        
        **Search:**
        - Searches across word, reading, and meaning fields
        - Case-insensitive partial matching
        
        **Categories:**
        - Words are automatically grouped by category
        - Categories: food, time, verb, adjective, etc.
      operationId: getVocabulary
      security: []
      parameters:
        - name: levelId
          in: query
          required: true
          schema:
            type: integer
            minimum: 1
          description: JLPT level ID (1=N5, 2=N4, etc.)
          example: 1
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 10
            maximum: 500
            default: 25
          description: Number of items per page
        - name: cursor
          in: query
          schema:
            type: integer
          description: Last category ID from previous page (for pagination)
          example: 10
        - name: search
          in: query
          schema:
            type: string
            minLength: 1
          description: Search term for filtering vocabulary
          example: hello
      responses:
        '200':
          description: Paginated vocabulary data grouped by categories
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VocabularyResponse'
        '400':
          description: Invalid query parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: Invalid query parameters